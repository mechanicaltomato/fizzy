#!/usr/bin/env bash
# Fizzy Fly.io Deployment Script (FREE TIER ONLY)
# This script helps you deploy to Fly.io without incurring charges

set -e

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${GREEN}üöÄ Fizzy Fly.io Deployment (FREE TIER)${NC}"
echo ""

# Check if flyctl is in PATH
if ! command -v flyctl &> /dev/null; then
  echo -e "${YELLOW}Adding flyctl to PATH...${NC}"
  export PATH="/Users/pdrlaguna/.fly/bin:$PATH"
fi

# Check if logged in
if ! flyctl auth whoami &> /dev/null; then
  echo -e "${RED}‚ùå Not logged in to Fly.io${NC}"
  echo "Please run: flyctl auth login"
  exit 1
fi

echo -e "${GREEN}‚úì Logged in to Fly.io${NC}"
echo ""

# Check if app exists
APP_NAME=$(grep "^app = " fly.toml | cut -d "'" -f 2)

if ! flyctl apps list | grep -q "$APP_NAME"; then
  echo -e "${YELLOW}üìù Creating new app: $APP_NAME${NC}"
  echo ""
  echo -e "${YELLOW}‚ö†Ô∏è  IMPORTANT: Confirming FREE TIER settings:${NC}"
  echo "  - VM: shared-cpu-1x with 256MB RAM (FREE)"
  echo "  - Instances: max 1 (FREE)"
  echo "  - Volume: 1GB (FREE - up to 3GB total)"
  echo "  - Auto-stop when idle (FREE)"
  echo ""

  # Create app without deploying
  flyctl apps create "$APP_NAME" --yes || {
    echo -e "${RED}‚ùå Failed to create app${NC}"
    exit 1
  }

  echo -e "${GREEN}‚úì App created${NC}"
  echo ""

  # Create volume for SQLite
  echo -e "${YELLOW}üíæ Creating 1GB volume for database...${NC}"
  flyctl volumes create fizzy_data --size 1 --app "$APP_NAME" --yes || {
    echo -e "${RED}‚ùå Failed to create volume${NC}"
    exit 1
  }

  echo -e "${GREEN}‚úì Volume created${NC}"
  echo ""
fi

# Set secrets
echo -e "${YELLOW}üîê Setting up secrets...${NC}"

# Check for production credentials key first, fall back to master.key
if [ -f config/credentials/production.key ]; then
  MASTER_KEY=$(cat config/credentials/production.key)
elif [ -f config/master.key ]; then
  MASTER_KEY=$(cat config/master.key)
else
  echo -e "${RED}‚ùå No credentials key found!${NC}"
  echo "Run: bin/rails credentials:edit --environment production"
  exit 1
fi

flyctl secrets set RAILS_MASTER_KEY="$MASTER_KEY" --app "$APP_NAME" --stage

echo -e "${GREEN}‚úì Secrets configured${NC}"
echo ""

# Deploy
echo -e "${YELLOW}üö¢ Deploying to Fly.io (this may take a few minutes)...${NC}"
flyctl deploy --app "$APP_NAME" --ha=false || {
  echo -e "${RED}‚ùå Deployment failed${NC}"
  exit 1
}

echo ""
echo -e "${GREEN}‚úÖ Deployment successful!${NC}"
echo ""
echo -e "Your app is live at: ${GREEN}https://$APP_NAME.fly.dev${NC}"
echo ""
echo -e "${YELLOW}üìä Useful commands:${NC}"
echo "  flyctl status          - Check app status"
echo "  flyctl logs            - View logs"
echo "  flyctl ssh console     - SSH into the VM"
echo "  flyctl scale show      - Verify free tier settings"
echo ""
echo -e "${YELLOW}‚ö†Ô∏è  Remember: This is FREE TIER ONLY${NC}"
echo "  - App auto-stops when idle (no traffic)"
echo "  - First request after idle may be slow (cold start)"
echo "  - Performance will be limited but FREE"
echo ""
