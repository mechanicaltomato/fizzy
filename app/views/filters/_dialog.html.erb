<dialog class="filter__popup dialog panel fill-white shadow" aria-label="Filter" aria-description="Filter" data-dialog-target="dialog">
  <div class="flex flex-column gap-half">
    <div class="flex align-center gap-half justify-space-between">
      <span class="btn btn--placeholder txt-small" aria-hidden="true"></span>

      <h2 class="txt-large flex align-center gap-half margin-none">
        <%= icon_tag "filter", size: 30 %>
        <span>Filter</span>
      </h2>

      <form method="dialog">
        <button class="btn panel__close txt-small" title="Close (esc)">
          <%= icon_tag "remove" %>
          <span class="for-screen-reader">Close</span>
        </button>
      </form>
    </div>

    <div class="pad fill-shade border-radius margin-block-end">
      <%= form_tag bubbles_path, class: "flex align-center gap input input--actor txt-small fill-white border-radius", method: :get do %>
        <% @filter.as_params.each do |key, value| %>
          <%= filter_hidden_field_tag key, value %>
        <% end %>

        <%= search_field_tag "terms[]", nil, class: "input full-width", placeholder: "By keywordâ€¦", id: nil %>

        <button class="btn">
          <span class="for-screen-reader">Apply</span>
          <%= icon_tag "arrow-right" %>
        </button>
      <% end %>
    </div>

    <%= form_with url: bubbles_path, id: :filter_form, method: :get, class: "flex flex-column gap full-width", style: "--border-color: var(--color-subtle)" do %>
      <% Array(params[:terms]).each do |term| %>
        <%= hidden_field_tag "terms[]", term, id: nil %>
      <% end %>

      <div class="filter__columns flex gap">
        <menu class="filter__menu">
          <li class="filter__label"><strong>In Collection</strong></li>

          <li>
            <%= button_tag type: :button, class: "btn filter__button", data: { action: "filter-form#clearCategory", filter_form_name_param: "bucket_ids[]" } do %>
              <span>All Collections</span>
            <% end %>
          </li>

          <% Current.user.buckets.order(:name).each do |bucket| %>
            <li>
              <%= label_tag "bucket_ids_#{bucket.id}", class: "btn filter__button" do %>
                <%= check_box_tag "bucket_ids[]", bucket.id, filter.buckets.include?(bucket), id: "bucket_ids_#{bucket.id}", hidden: true %>
                <span><%= bucket.name %></span>
                <%= icon_tag "close" %>
              <% end %>
            </li>
          <% end %>
        </menu>

        <menu class="filter__menu">
          <li class="filter__label"><strong>Sort by</strong></li>
          <li>
            <%= label_tag "indexed_by_#{filter.default_indexed_by}", class: "btn filter__button" do %>
              <%= radio_button_tag "indexed_by", filter.default_indexed_by, filter.default_indexed_by?, hidden: true %>
              <span>Most active</span>
              <%= icon_tag "close" %>
            <% end %>
          </li>

          <% Filter::INDEXES.each do |index| %>
            <li>
              <label class="btn filter__button">
                <%= radio_button_tag "indexed_by", index, filter.indexed_by == index, class: "visually-hidden" %>
                <span><%= index.humanize %></span>
                <%= icon_tag "close" %>
              </label>
            </li>
          <% end %>
        </menu>
        </menu>
      </div>
    <% end %>
  </div>

  <div class="flex align-center txt-align-center justify-space-between gap-half margin-block-start">
    <%= tag.button class: "btn", form: :filter_form, formaction: filters_path, formmethod: :post do %>
      <%= icon_tag "bubbles" %>
      <span>Save collection</span>
    <% end %>

    <button class="btn btn--reversed" form="filter_form">
      <span>Apply</span>
      <%= icon_tag "arrow-right" %>
    </button>
  </div>
</dialog>
